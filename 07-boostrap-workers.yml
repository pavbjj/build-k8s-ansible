---
- name: Generate kubelet configs dynamically
  hosts: localhost
  vars:
    workers:
      - worker-1
      - worker-2
  tasks:
    - name: Render kubeconfig for each worker
      ansible.builtin.template:
        src: kubelet.kubeconfig.j2
        dest: "/home/pawel/k8s-ansible/kubelet-{{ item }}.kubeconfig"
      loop: "{{ workers }}"
      vars:
        worker_name: "{{ item }}"

- name: Generate certificates for worker nodes on master-1
  hosts: master-1
  become: true
  vars:
    workers:
      - worker-1
      - worker-2
  tasks:
    - name: Get the IPs of worker nodes
      command: dig +short {{ item }}
      loop: "{{ workers }}"
      register: worker_ips
      changed_when: false

    - name: Get the IP of loadbalancer
      command: dig +short loadbalancer
      register: loadbalancer_ip
      changed_when: false

    - name: Generate OpenSSL configuration files for workers
      copy:
        dest: "/tmp/openssl-{{ item }}.cnf"
        content: |
          [req]
          req_extensions = v3_req
          distinguished_name = req_distinguished_name
          [req_distinguished_name]
          [ v3_req ]
          basicConstraints = CA:FALSE
          keyUsage = nonRepudiation, digitalSignature, keyEncipherment
          subjectAltName = @alt_names
          [alt_names]
          DNS.1 = {{ item }}
          IP.1 = {{
            worker_ips.results | selectattr('item', 'equalto', item) | map(attribute='stdout') | first
          }}
      loop: "{{ workers }}"

    - name: Set cluster parameters for kubeconfig
      command: >
        kubectl config set-cluster c-serv-k8s
        --certificate-authority=/var/lib/kubernetes/pki/ca.crt
        --server=https://10.171.176.130:6443
        --kubeconfig=/var/kubernetes/pki/{{ item }}.kubeconfig
      loop: "{{ workers }}"

    - name: Set credentials for kubeconfig
      command: >
        kubectl config set-credentials system:node:{{ item }}
        --client-certificate=/var/lib/kubernetes/pki/{{ item }}.crt
        --client-key=/var/lib/kubernetes/pki/{{ item }}.key
        --kubeconfig=/var/kubernetes/pki/{{ item }}.kubeconfig
      loop: "{{ workers }}"

    - name: Set context for kubeconfig
      command: >
        kubectl config set-context default
        --cluster=c-serv-k8s
        --user=system:node:{{ item }}
        --kubeconfig=/var/kubernetes/pki/{{ item }}.kubeconfig
      loop: "{{ workers }}"

    - name: Use default context in kubeconfig
      command: >
        kubectl config use-context default
        --kubeconfig=/var/kubernetes/pki/{{ item }}.kubeconfig
      loop: "{{ workers }}"

    - name: Generate private key for worker
      command: openssl genrsa -out /tmp/{{ item }}.key 2048
      args:
        creates: /tmp/{{ item }}.key
      loop: "{{ workers }}"

    - name: Generate CSR for worker
      command: >
        openssl req -new -key /tmp/{{ item }}.key -subj "/CN=system:node:{{ item }}/O=system:nodes"
        -out /tmp/{{ item }}.csr -config /tmp/openssl-{{ item }}.cnf
      args:
        creates: /tmp/{{ item }}.csr
      loop: "{{ workers }}"

    - name: Sign CSR to generate certificate
      command: >
        openssl x509 -req -in /tmp/{{ item }}.csr -CA /etc/kubernetes/pki/ca.crt
        -CAkey /home/pawel/ca.key -CAcreateserial -out /tmp/{{ item }}.crt
        -extensions v3_req -extfile /tmp/openssl-{{ item }}.cnf -days 1000
      args:
        creates: /tmp/{{ item }}.crt
      loop: "{{ workers }}"

    - name: Copy kubeconfig and CA to /tmp
      command: cp /var/kubernetes/pki/{{ item }}.kubeconfig /home/pawel/ca.crt /tmp/
      loop: "{{ workers }}"

    - name: Chmod kubeconfig
      command: chmod 755 /tmp/{{ item }}.kubeconfig
      loop: "{{ workers }}"

    - name: Ensure pawel can read worker keys
      file:
        path: "/tmp/{{ item }}.key"
        mode: '0644'
      loop: "{{ workers }}"

    - name: Ensure pawel can read worker certs
      file:
        path: "/tmp/{{ item }}.crt"
        mode: '0644'
      loop: "{{ workers }}"

    - name: Ensure pawel can read kubeconfigs
      file:
        path: "/tmp/{{ item }}.kubeconfig"
        mode: '0644'
      loop: "{{ workers }}"

    - name: Securely copy worker certs using scp
      become: false
      shell: scp /tmp/{{ item }}.key /tmp/{{ item }}.crt /tmp/{{ item }}.kubeconfig /home/pawel/ca.crt pawel@{{ item }}:/tmp/
      loop: "{{ workers }}"

    - name: Securely copy kube-proxy certs to worker
      become: false
      shell: scp /home/pawel/kube-proxy.crt /home/pawel/k8s-ansible/kubelet-{{ item }}.kubeconfig /home/pawel/kube-proxy.key /home/pawel/kube-proxy.kubeconfig pawel@{{ item }}:/tmp/
      loop: "{{ workers }}"

- name: Bootstrap Kubernetes Worker Nodes
  hosts: 
    - worker-1
    - worker-2
  become: true
  vars:
    ca_cert: ca.crt
    pod_cidr: "10.244.0.0/16"
    service_cidr: "10.96.0.0/16"
    cluster_domain: cluster.local
    resolv_conf: /run/systemd/resolve/resolv.conf

  tasks:
    - name: Set worker_cert dynamically
      set_fact:
        worker_cert: "{{ inventory_hostname }}"

    - name: Download and install worker binaries
      ansible.builtin.get_url:
        url: "https://storage.googleapis.com/kubernetes-release/release/v1.24.3/bin/linux/amd64/{{ item }}"
        dest: "/usr/local/bin/{{ item }}"
        mode: '0755'
      loop:
        - kubectl
        - kube-proxy
        - kubelet

    - name: Create required directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - /var/lib/kubelet
        - /var/lib/kube-proxy
        - /var/lib/kubernetes/pki
        - /var/run/kubernetes

    - name: Move certificates and keys to correct directories
      ansible.builtin.shell: |
        cp /tmp/{{ worker_cert }}.key /tmp/kube-proxy.* /tmp/{{ worker_cert }}.crt /var/lib/kubernetes/pki/
        cp /tmp/kubelet-{{ worker_cert }}.kubeconfig /var/lib/kubelet/kubelet.kubeconfig
        cp /tmp/kube-proxy.kubeconfig /var/lib/kube-proxy/kube-proxy.kubeconfig
        cp /tmp/ca.crt /var/lib/kubernetes/pki/
      args:
        executable: /bin/bash

    - name: Secure permissions for certificates and kubeconfig
      ansible.builtin.file:
        path: "{{ item.path }}"
        owner: root
        group: root
        mode: "{{ item.mode }}"
      loop:
        - { path: "/var/lib/kubernetes/pki/{{ worker_cert }}.key", mode: '0600' }
        - { path: "/var/lib/kubernetes/pki/{{ worker_cert }}.crt", mode: '0600' }
        - { path: "/var/lib/kubelet/kubelet.kubeconfig", mode: '0600' }
        - { path: "/var/lib/kubernetes/pki/{{ ca_cert }}", mode: '0600' }

    - name: Compute cluster DNS address
      ansible.builtin.set_fact:
        cluster_dns: "{{ service_cidr.split('.')[0:3] | join('.') }}.10"

    - name: Create kubelet configuration file
      ansible.builtin.template:
        src: kubelet-config.yaml.j2
        dest: /var/lib/kubelet/kubelet-config.yaml

    - name: Create kubelet systemd unit file
      ansible.builtin.copy:
        dest: /etc/systemd/system/kubelet.service
        content: |
          [Unit]
          Description=Kubernetes Kubelet
          Documentation=https://github.com/kubernetes/kubernetes
          After=containerd.service
          Requires=containerd.service

          [Service]
          ExecStart=/usr/local/bin/kubelet \
            --config=/var/lib/kubelet/kubelet-config.yaml \
            --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock \
            --kubeconfig=/var/lib/kubelet/kubelet.kubeconfig \
            --v=2
          Restart=on-failure
          RestartSec=5

          [Install]
          WantedBy=multi-user.target

    - name: Move kube-proxy kubeconfig
      ansible.builtin.shell: cp /tmp/{{ worker_cert }}.kubeconfig /var/lib/kube-proxy/

    - name: Create kube-proxy configuration file
      ansible.builtin.template:
        src: kube-proxy-config.yaml.j2
        dest: /var/lib/kube-proxy/kube-proxy-config.yaml

    - name: Create kube-proxy systemd unit file
      ansible.builtin.copy:
        dest: /etc/systemd/system/kube-proxy.service
        content: |
          [Unit]
          Description=Kubernetes Kube Proxy
          Documentation=https://github.com/kubernetes/kubernetes

          [Service]
          ExecStart=/usr/local/bin/kube-proxy \
            --config=/var/lib/kube-proxy/kube-proxy-config.yaml
          Restart=on-failure
          RestartSec=5

          [Install]
          WantedBy=multi-user.target

    - name: Start and enable kubelet and kube-proxy services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - kubelet
        - kube-proxy
